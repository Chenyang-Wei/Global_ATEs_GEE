/*
  Introduction:
  1) Group the elevational transects in different basins. 
  2) Filter the transects between 500m and 3km. 
  3) Determine the annual maximum ATEIs within each buffered transect.
  
  Update: 11/29/2020.
  
  Runtime: 10m ~ 21m (# of transects: 85424 ~ 180945).
*/


/* Setup. */

// Set the work directory.
var wd = "users/treeline/NorthAmerica_GME/";

// Annual ATEIs.
var ATEI = ee.Image(wd +
  "Annual_ATEI/ATEI_medianSmdAnlMaxAvgNDVIs_2000to2019");

// print("ATEI:", ATEI.bandTypes(),
//   ATEI.projection().crs(),
//   ATEI.projection().nominalScale())


/* Functions to load and combine transects. */

// Hybas-4.
function combineTransects_Hybas4(index) {
  // Load transects in each basin.
  var transects = ee.FeatureCollection(wd + 
    "Transects/30mBufTransects30mRes_90mSegmentedCATE_Hybas4/Basin_" 
    + index);
  
  return transects;
}

// Hybas-5.
function combineTransects_Hybas5(index) {
  // Load transects in each basin.
  var transects = ee.FeatureCollection(wd + 
    "Transects/30mBufTransects30mRes_90mSegmentedCATE_Hybas4/Basin23_Hybas5/Basin23_" 
    + index);
  
  return transects;
}


/* Create a list of index groups of basins. */

// Hybas-4.
var group1 = ee.List.sequence(0, 22).getInfo();
var group2 = ee.List.sequence(24, 30).getInfo();
var group3 = ee.List.sequence(31, 40).getInfo();
var group4 = ee.List.sequence(41, 60).getInfo();
var group5 = ee.List.sequence(61, 80).getInfo();
var group6 = ee.List.sequence(81, 100).getInfo();
var group7 = ee.List.sequence(101, 126).getInfo();

// Hybas-5.
var group8 = ee.List.sequence(0, 7).getInfo();


/* Load and filter the transects of each group. */

// Function to filter the transects between 500m and 3km.

function filterTransects(tr) {
  return tr.filter(ee.Filter.and(
    ee.Filter.gte("Length_m", 500),
    ee.Filter.lte("Length_m", 3000)
  ));
}

// Hybas-4.
var transects1 = filterTransects(ee.FeatureCollection(group1.map(combineTransects_Hybas4)).flatten());
var transects2 = filterTransects(ee.FeatureCollection(group2.map(combineTransects_Hybas4)).flatten());
var transects3 = filterTransects(ee.FeatureCollection(group3.map(combineTransects_Hybas4)).flatten());
var transects4 = filterTransects(ee.FeatureCollection(group4.map(combineTransects_Hybas4)).flatten());
var transects5 = filterTransects(ee.FeatureCollection(group5.map(combineTransects_Hybas4)).flatten());
var transects6 = filterTransects(ee.FeatureCollection(group6.map(combineTransects_Hybas4)).flatten());
var transects7 = filterTransects(ee.FeatureCollection(group7.map(combineTransects_Hybas4)).flatten());

print("transects1:", transects1.first(),
  transects1.size()) // 180945.
print("transects2:", transects2.size())
print("transects3:", transects3.size())
print("transects4:", transects4.size())
print("transects5:", transects5.size())
print("transects6:", transects6.size())
print("transects7:", transects7.size())

// Hybas-5
var transects8 = filterTransects(ee.FeatureCollection(group8.map(combineTransects_Hybas5)).flatten());

print("transects8:", transects8.size())


/* Determine the annual maximum ATEIs within each buffered transect. */

var transects1_maxATEI = ATEI.reduceRegions({
  collection: transects1,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects2_maxATEI = ATEI.reduceRegions({
  collection: transects2,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects3_maxATEI = ATEI.reduceRegions({
  collection: transects3,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects4_maxATEI = ATEI.reduceRegions({
  collection: transects4,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects5_maxATEI = ATEI.reduceRegions({
  collection: transects5,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects6_maxATEI = ATEI.reduceRegions({
  collection: transects6,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects7_maxATEI = ATEI.reduceRegions({
  collection: transects7,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});

var transects8_maxATEI = ATEI.reduceRegions({
  collection: transects8,
  reducer: ee.Reducer.max(),
  scale: 30,
  crs: "EPSG:4326"
});


/* Export the generated transects to the Asset. */

if (false) {
  var fileName1 = "transects1_500mTo3km_maxATEI_2000to2019";
  var fileName2 = "transects2_500mTo3km_maxATEI_2000to2019";
  var fileName3 = "transects3_500mTo3km_maxATEI_2000to2019";
  var fileName4 = "transects4_500mTo3km_maxATEI_2000to2019";
  var fileName5 = "transects5_500mTo3km_maxATEI_2000to2019";
  var fileName6 = "transects6_500mTo3km_maxATEI_2000to2019";
  var fileName7 = "transects7_500mTo3km_maxATEI_2000to2019";
  var fileName8 = "transects8_500mTo3km_maxATEI_2000to2019";
  
  Export.table.toAsset({
    collection: transects1_maxATEI, 
    description: fileName1, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName1
  });
  
  Export.table.toAsset({
    collection: transects2_maxATEI, 
    description: fileName2, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName2
  });
  
  Export.table.toAsset({
    collection: transects3_maxATEI, 
    description: fileName3, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName3
  });
  
  Export.table.toAsset({
    collection: transects4_maxATEI, 
    description: fileName4, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName4
  });
  
  Export.table.toAsset({
    collection: transects5_maxATEI, 
    description: fileName5, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName5
  });
  
  Export.table.toAsset({
    collection: transects6_maxATEI, 
    description: fileName6, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName6
  });
  
  Export.table.toAsset({
    collection: transects7_maxATEI, 
    description: fileName7, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName7
  });
  
  Export.table.toAsset({
    collection: transects8_maxATEI, 
    description: fileName8, 
    assetId: wd + "Transects/ATEI_analysis/Transects_maxATEI/" + fileName8
  });
}

