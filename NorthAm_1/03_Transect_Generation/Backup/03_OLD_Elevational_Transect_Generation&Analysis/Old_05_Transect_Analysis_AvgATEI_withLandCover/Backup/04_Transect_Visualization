/*
  Introduction:
  1) Visualize transects with the trend of the ATEI-weighted average elevation.
  
  Update: 1/12/2020.
*/


/* Setup. */

// Set the work directory.
var wd = "users/treeline/NorthAmerica_GME/";

// Annual ATEIs.
var ATEI_1 = ee.Image(wd +
  "Annual_ATEI/ATEI_medianSmdAnlMaxAvgNDVIs_1984to1999");
var ATEI_2 = ee.Image(wd +
  "Annual_ATEI/ATEI_medianSmdAnlMaxAvgNDVIs_2000to2019");

var ATEI = ATEI_1.addBands(ATEI_2);

// var spectralPalette = ["9e0142","d53e4f","f46d43","fdae61","fee08b","ffffbf","e6f598","abdda4","66c2a5","3288bd","5e4fa2"];
// var YlGn = ["ffffe5","f7fcb9","d9f0a3","addd8e","78c679","41ab5d","238443","006837","004529"];
var PiYG = ["8e0152","c51b7d","de77ae","f1b6da","fde0ef","f7f7f7","e6f5d0","b8e186","7fbc41","4d9221","276419"];

var ATEIvisParams = {min: 0, max: 1, palette: PiYG};

var trendVisParams = {min: -1, max: 1, palette: "0000FF, FFFFFF, FF0000"};

var ATEI_ic = ee.ImageCollection.fromImages(ATEI.bandNames().map(function(b) {
  return ATEI.select([b]).visualize(ATEIvisParams);
}));

var transects = ee.FeatureCollection(wd + 
  "Transects/ATEI_analysis/transectTrend_gte10obs");

// print("# of new transects:", transects.size())
// print("First new transects:", transects.first())

var emptyDouble = ee.Image().double();

// Paint the outlines of transects.
var outlines = emptyDouble
  .paint({
    featureCollection: transects, 
    color: "elvTrnd", 
    width: 3
  });

var visualizedOutlines = outlines.visualize(trendVisParams);

// Overlap the visualized outlines with each image of ATEI.
ATEI_ic = ATEI_ic.map(function(img) {
  return img.blend(visualizedOutlines);
});

// Add an image to show the end of each animation.
ATEI_ic = ATEI_ic.merge(ee.Image.constant(0.5).visualize(ATEIvisParams));

// // Paint the fills of transects.
// var fills = emptyDouble
//   .paint({
//     featureCollection: transects, 
//     color: "elvTrnd"
//   });

function defineParams(pt) {
  var thumbParams = {
    dimensions: 300,
    region: pt.buffer(1e3),
    framesPerSecond: 2,
    crs: 'EPSG:3857'
  };
  
  return thumbParams;
}


// // Copernicus land cover product.
// var copernicus = ee.ImageCollection("COPERNICUS/Landcover/100m/Proba-V/Global")
//   .select('discrete_classification').first();

// // Closed forests in the Copernicus dataset.
// var closedForests = copernicus.gte(111).and(copernicus.lte(116))
//   .selfMask()
//   .rename("closedForests");

// // Non-forested areas in the Copernicus dataset.
// // From "Shrubs" to "Moss and lichen".
// var nonForested = copernicus.gte(20).and(copernicus.lte(100))
//   .selfMask()
//   .rename("nonForested");


/* Visualization. */

var year = 2019;

// Extract the elevation trend at the clicked point.
function extractTrend(pt) {
  var selectedTransects = transects.filterBounds(pt);
  
  var selectedTrend = ee.Algorithms.If({
    condition: selectedTransects.size().neq(0), 
    trueCase: selectedTransects.first().get("elvTrnd"), 
    falseCase: "no selected transect"
  });
  
  return selectedTrend;
}


/* Create a zoom box panel to show a detailed view of the clicked point. */

var point = ee.Geometry.Point([-113.93251, 48.88829]);

// Create an animation of ATEI around the clicked point.
var thumbNail = ui.Thumbnail(ATEI_ic, defineParams(point));

// An empty panel.
var zoomPanel = ui.Panel({
  style: {
    position: 'bottom-right',
    height: '340px',
    width: '300px',
  }
});

// Instruction information.
var zoomInstructions = ui.Label({
  value: 'ATEI animation (ATE in green)', 
  style: {
    fontWeight: 'bold',
    fontSize: "15px",
    padding: "0px 2px",
    stretch: 'horizontal',
    textAlign: 'center',
    color: 'gray'
  }
});

var zoomLabel = ui.Label("Elevation trend: " + extractTrend(point).getInfo());

var zoomBox = ui.Panel().add(zoomLabel).add(thumbNail);

// Add widgets to the zoom panel.
zoomPanel.add(zoomInstructions);
zoomPanel.add(zoomBox);


/* Arrange the generated panels. */

var map = ui.Map();

map.style().set("cursor", "crosshair");
map.setOptions("HYBRID");
map.centerObject(point, 7);

// Add the zoom box panel to the default map.
map.add(zoomPanel);

map.addLayer(ATEI.select("ATEI_" + year), 
  ATEIvisParams, "ATEI in " + year, false);

// map.addLayer(closedForests, {palette: "228B22"}, "Closed Forests", false);
// map.addLayer(nonForested, {palette: "808080"}, "Non-Forested", false);

// map.addLayer(fills, trendVisParams, "Elevation Trend", false); // Add fills to display the value of trend when clicked.
map.addLayer(visualizedOutlines, {}, "Elevation Trend (outline)"); // Add outlines to show the color when zoomed out.

map.addLayer(point, {color: "FFFF00"}, "Clicked point");

map.onClick(function(coordinates){
  var point = ee.Geometry.Point([coordinates.lon, coordinates.lat]);
  var thumbNail = ui.Thumbnail(ATEI_ic, defineParams(point));
  
  var selected = transects.filterBounds(point).first().get("elvTrnd");
  var zoomLabel = ui.Label("Elevation trend: " + extractTrend(point).getInfo());

  map.centerObject(point, 14);
  
  zoomBox.clear();
  zoomBox.add(zoomLabel);
  zoomBox.add(thumbNail);
  
  var clicked = ui.Map.Layer(point, {color: "FFFF00"}, "Clicked point");
  map.layers().set(2, clicked);
});

ui.root.clear();
ui.root.add(map);


