/**
 * Introduction:
 * 1) Load the elevational transects of the "hybas_4" basins based on the land cover information.
 * 3) Combine all the generated elevational transects.
 * 
 * Date: 12/16/2020.
 * 
 * Runtime: 52m.
 */


/* Setup. */

// Asset path.
var wdNorthA = "users/treeline/NorthAmerica_GME/";

if (false) {
  /* Read the elevational transects of the "hybas_4" basins based on the land cover information. */
  
  // Create a list of indices.
  var indices = ee.List.sequence(0, 125);
  
  // Remove the failed task.
  indices = indices.remove(9).getInfo();
  
  var succeeded = ee.FeatureCollection(indices.map(function(index) {
    // Load transects in each basin.
    var transects = ee.FeatureCollection(wdNorthA 
      + "Transects/30mBufTransects30mRes_90mSegmentedCATE_Hybas4_withLandCover/Basin_" 
      + index);
    
    return transects;
  })).flatten();
} 

else {
  /* Read the previously combined transects. */
  
  var succeeded = ee.FeatureCollection(wdNorthA + 
    "Transects/30mBufTransects30mRes_90mSegmentedCATE_Hybas4_combined_withLandCover");
}

print("# of transects:", succeeded.size()) // 558,823.
print("Transects:", succeeded.limit(10))

if (true) {
  // HydroSHEDS basins ("hybas_4") with the segmented CATE pixels.
  var basins = ee.FeatureCollection(wdNorthA + "Transects/" + 
    "90mSegmentedCATE_selectedBasins_Hybas4_withLandCover");
  
  // Segmented CATE.
  var segCATE = ee.Image(wdNorthA + "Transects/" + 
    "90mSegmentedCATE_distToRidgesNoCliff_NAlandformsRemoved_ridgesRemoved");


  /* Extract the failed HydroSHEDS ("hybas_4") basins. */
  
  var basinNum = basins.size();
  
  var basinList = basins.toList({
    count: basinNum
  });
  
  var failed = ee.Feature(basinList.get(9));
  
  // Map.setCenter(-113.7571, 48.829, 10); // GNP.
  Map.setCenter(-129.2425, 64.8198, 10); // North-western Canada.
  // Map.centerObject(failed, 10); // Failed basin.
  
  Map.setOptions("hybrid");
  
  Map.addLayer(basins, {color: "FFFFFF"}, "Basins (Hybas 4)", true);
  
  Map.addLayer(failed, {color: "FFFF00"}, "Failed Basin (Hybas 4)", true);
  
  Map.addLayer(segCATE, {palette: "0000FF"}, "Segmented CATE", true);
  
  Map.addLayer(succeeded, {color: "FF0000"}, "Transects", true);
}

else if (true) {
  /* Output the combined transects.*/
  
  var fileName = "30mBufTransects30mRes_90mSegmentedCATE_Hybas4_combined_withLandCover";
  
  Export.table.toAsset({
    collection: succeeded, 
    description: fileName, 
    assetId: wdNorthA + "Transects/" + fileName
  });
}

